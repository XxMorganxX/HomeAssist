# ============================================
# GitHub Actions Workflow for Scheduled Events
# ============================================
# Runs email and news summarizers on a cron schedule
# Results are stored in Supabase notification_sources table
#
# REQUIRED SECRETS (Settings â†’ Secrets â†’ Actions â†’ Repository secrets):
#   - GEMINI_API_KEY        : Google Gemini API key (email summarization)
#   - OPENAI_API_KEY        : OpenAI API key (news analysis)
#   - SUPABASE_URL          : Supabase project URL
#   - SUPABASE_KEY          : Supabase service role key
#   - NEWS_API_KEY_1        : NewsAPI.org key (get free at newsapi.org)
#
# OPTIONAL SECRETS (for email summarizer):
#   - GMAIL_CLIENT_ID       : From Google Cloud Console OAuth credentials
#   - GMAIL_CLIENT_SECRET   : From Google Cloud Console OAuth credentials
#   - GMAIL_REFRESH_TOKEN   : From your token.json (get via reauth_gmail.py locally)
#   - NEWS_API_KEY_2 to _5  : Additional NewsAPI keys for quota rotation
#
# OPTIONAL VARIABLES (Settings â†’ Secrets â†’ Actions â†’ Variables):
#   - EMAIL_NOTIFICATION_RECIPIENT : Target user (default: Morgan)
#   - NEWS_NOTIFICATION_RECIPIENT  : Target user (default: Morgan)
# ============================================

name: Scheduled Events (Email & News)

on:
  # Run daily at 7:00 AM UTC (2:00 AM EST / 3:00 AM EDT)
  schedule:
    - cron: '0 7 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      skip_email:
        description: 'Skip email summarizer'
        required: false
        default: 'false'
        type: boolean
      skip_news:
        description: 'Skip news summarizer'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.12'

jobs:
  run-scheduled-events:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/scheduled/requirements_cron.txt
      
      - name: Set up environment variables
        run: |
          echo "Setting up environment..."
        env:
          # These secrets must be configured in GitHub repo settings
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          EMAIL_NOTIFICATION_RECIPIENT: ${{ vars.EMAIL_NOTIFICATION_RECIPIENT || 'Morgan' }}
          NEWS_NOTIFICATION_RECIPIENT: ${{ vars.NEWS_NOTIFICATION_RECIPIENT || 'Morgan' }}
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # EMAIL SUMMARIZER
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Email Summarizer
        if: ${{ github.event.inputs.skip_email != 'true' }}
        working-directory: scripts/scheduled/email_summarizer
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          EMAIL_NOTIFICATION_RECIPIENT: ${{ vars.EMAIL_NOTIFICATION_RECIPIENT || 'Morgan' }}
          # Gmail OAuth via environment variables (no files needed!)
          # Extract these from your Google OAuth JSON credentials
          GMAIL_CLIENT_ID: ${{ secrets.GMAIL_CLIENT_ID }}
          GMAIL_CLIENT_SECRET: ${{ secrets.GMAIL_CLIENT_SECRET }}
          GMAIL_REFRESH_TOKEN: ${{ secrets.GMAIL_REFRESH_TOKEN }}
          # Mark as headless/CI environment
          CI: 'true'
        run: |
          echo "ğŸ“§ Running email summarizer..."
          
          # Create ephemeral data directory
          mkdir -p ephemeral_data
          
          # Check if Gmail credentials are configured
          if [ -n "$GMAIL_CLIENT_ID" ] && [ -n "$GMAIL_CLIENT_SECRET" ] && [ -n "$GMAIL_REFRESH_TOKEN" ]; then
            echo "âœ… Gmail OAuth credentials found (via environment variables)"
            python mail_main.py || echo "âš ï¸ Email summarizer completed with warnings"
          else
            echo "â­ï¸ Skipping email summarizer (Gmail credentials not configured)"
            echo "   To enable, add these secrets: GMAIL_CLIENT_ID, GMAIL_CLIENT_SECRET, GMAIL_REFRESH_TOKEN"
          fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # NEWS SUMMARIZER
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run News Summarizer
        if: ${{ github.event.inputs.skip_news != 'true' }}
        working-directory: scripts/scheduled/news_summary
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          # NewsAPI keys (supports rotation when quota exhausted)
          # If you only have one key, set NEWS_API_KEY_1 or NEWS_API_KEY
          NEWS_API_KEY_1: ${{ secrets.NEWS_API_KEY_1 || secrets.NEWS_API_KEY }}
          NEWS_API_KEY_2: ${{ secrets.NEWS_API_KEY_2 }}
          NEWS_API_KEY_3: ${{ secrets.NEWS_API_KEY_3 }}
          NEWS_API_KEY_4: ${{ secrets.NEWS_API_KEY_4 }}
          NEWS_API_KEY_5: ${{ secrets.NEWS_API_KEY_5 }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          NEWS_NOTIFICATION_RECIPIENT: ${{ vars.NEWS_NOTIFICATION_RECIPIENT || 'Morgan' }}
        run: |
          echo "ğŸ“° Running news summarizer..."
          
          # Debug: Check if API keys are set (shows only if set, not the value)
          echo "Checking NewsAPI keys..."
          [ -n "$NEWS_API_KEY_1" ] && echo "âœ… NEWS_API_KEY_1 is set" || echo "âŒ NEWS_API_KEY_1 is NOT set"
          [ -n "$NEWS_API_KEY_2" ] && echo "âœ… NEWS_API_KEY_2 is set" || echo "âšª NEWS_API_KEY_2 is not set (optional)"
          
          # Create ephemeral_data directory
          mkdir -p ephemeral_data
          
          # Run the news summarizer with cleanup
          python news_main.py --clean || echo "âš ï¸ News summarizer completed with warnings"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SUMMARY
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Print Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š SCHEDULED EVENTS COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "Check Supabase notification_sources table for results."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"


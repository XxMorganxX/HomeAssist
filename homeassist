#!/bin/bash
# ==============================================
# HomeAssist Control Script
# Can be run from anywhere: homeassist [command]
# ==============================================

PROJECT_DIR="$HOME/Desktop/HomeAssistV3"

case "$1" in
    start)
        echo "ğŸš€ Starting HomeAssist services..."
        # Stop watchdog to prevent duplicate processes
        launchctl unload ~/Library/LaunchAgents/com.homeassist.watchdog.plist 2>/dev/null
        # Start main services
        launchctl load ~/Library/LaunchAgents/com.homeassist.assistant.plist 2>/dev/null
        launchctl load ~/Library/LaunchAgents/com.homeassist.bluetooth.plist 2>/dev/null
        launchctl load ~/Library/LaunchAgents/com.homeassist.terminal.plist 2>/dev/null
        sleep 2
        launchctl list | grep homeassist
        ;;
    
    stop)
        echo "ğŸ›‘ Stopping HomeAssist services..."
        # Unload all services EXCEPT MCP (we want MCP to stay alive)
        launchctl unload ~/Library/LaunchAgents/com.homeassist.assistant.plist 2>/dev/null
        launchctl unload ~/Library/LaunchAgents/com.homeassist.bluetooth.plist 2>/dev/null
        launchctl unload ~/Library/LaunchAgents/com.homeassist.watchdog.plist 2>/dev/null
        
        # Kill all processes (aggressive) BUT NOT MCP server
        pkill -9 -f "homeassist run" 2>/dev/null
        pkill -9 -f "assistant_framework" 2>/dev/null
        pkill -9 -f "openwakeword" 2>/dev/null
        pkill -9 -f "multiprocessing.spawn" 2>/dev/null
        pkill -9 -f "multiprocessing.resource_tracker" 2>/dev/null
        
        # Kill audio processes
        pkill -9 -f "say " 2>/dev/null
        pkill -9 afplay 2>/dev/null
        pkill -9 -f "ffplay" 2>/dev/null
        pkill -9 -f "mpv" 2>/dev/null
        
        echo "âœ… Stopped (MCP server still running)"
        ;;
    
    restart)
        echo "ğŸ”„ Restarting HomeAssist..."
        # Kill any duplicate processes first
        pkill -f "python.*assistant_framework.main continuous" 2>/dev/null
        sleep 1
        launchctl kickstart -k gui/$(id -u)/com.homeassist.assistant
        sleep 2
        # Verify single instance
        COUNT=$(ps aux | grep "[p]ython.*assistant_framework.main" | wc -l | xargs)
        if [ "$COUNT" -eq 1 ]; then
            echo "âœ… Restarted (single instance)"
        else
            echo "âš ï¸  Warning: $COUNT instances running"
        fi
        ;;
    
    status)
        echo "ğŸ“Š HomeAssist Service Status:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        launchctl list | grep homeassist
        echo ""
        echo "Processes:"
        COUNT=$(ps aux | grep "[p]ython.*assistant" | grep -v grep | wc -l | xargs)
        ps aux | grep "[p]ython.*assistant" | grep -v grep || echo "  (no assistant process running)"
        if [ "$COUNT" -gt 2 ]; then
            echo ""
            echo "âš ï¸  WARNING: Multiple instances detected ($COUNT)"
            echo "   Run: homeassist restart"
        fi
        ;;
    
    logs)
        echo "ğŸ“‹ Opening live logs..."
        tail -f "${PROJECT_DIR}/logs/assistant_output.log" "${PROJECT_DIR}/logs/assistant_runner.log" 2>/dev/null
        ;;
    
    install)
        echo "ğŸ“¦ Running installer..."
        cd "${PROJECT_DIR}/os_background_service" && ./install.sh
        ;;
    
    uninstall)
        echo "ğŸ—‘ï¸  Running uninstaller..."
        cd "${PROJECT_DIR}/os_background_service" && ./uninstall.sh
        ;;
    
    mcp)
        MCP_PORT=3000
        MCP_PID_FILE="${PROJECT_DIR}/.mcp_server.pid"
        
        case "$2" in
            start)
                # Check if already running
                if [ -f "$MCP_PID_FILE" ]; then
                    OLD_PID=$(cat "$MCP_PID_FILE")
                    if kill -0 "$OLD_PID" 2>/dev/null; then
                        echo "âš ï¸  MCP server already running (PID: $OLD_PID)"
                        exit 0
                    fi
                fi
                
                echo "ğŸš€ Starting MCP server (SSE on port $MCP_PORT)..."
                cd "${PROJECT_DIR}"
                source .env 2>/dev/null
                
                # Start MCP server in background with SSE transport
                nohup ./venv/bin/python -m mcp_server.server --transport sse --port $MCP_PORT --quiet \
                    > "${PROJECT_DIR}/logs/mcp_server.log" 2>&1 &
                MCP_PID=$!
                echo $MCP_PID > "$MCP_PID_FILE"
                
                # Wait for server to be ready
                sleep 1
                if kill -0 "$MCP_PID" 2>/dev/null; then
                    echo "âœ… MCP server started (PID: $MCP_PID)"
                    echo "   URL: http://127.0.0.1:$MCP_PORT/sse"
                else
                    echo "âŒ MCP server failed to start"
                    cat "${PROJECT_DIR}/logs/mcp_server.log" | tail -20
                    rm -f "$MCP_PID_FILE"
                    exit 1
                fi
                ;;
            
            stop)
                if [ -f "$MCP_PID_FILE" ]; then
                    MCP_PID=$(cat "$MCP_PID_FILE")
                    if kill -0 "$MCP_PID" 2>/dev/null; then
                        echo "ğŸ›‘ Stopping MCP server (PID: $MCP_PID)..."
                        kill "$MCP_PID" 2>/dev/null
                        sleep 1
                        kill -9 "$MCP_PID" 2>/dev/null
                    fi
                    rm -f "$MCP_PID_FILE"
                    echo "âœ… MCP server stopped"
                else
                    # Also try to kill any stray MCP servers
                    pkill -f "mcp_server.server" 2>/dev/null
                    echo "âœ… MCP server stopped"
                fi
                ;;
            
            status)
                if [ -f "$MCP_PID_FILE" ]; then
                    MCP_PID=$(cat "$MCP_PID_FILE")
                    if kill -0 "$MCP_PID" 2>/dev/null; then
                        echo "âœ… MCP server running (PID: $MCP_PID)"
                        echo "   URL: http://127.0.0.1:$MCP_PORT/sse"
                        # Show tool count
                        TOOLS=$(curl -s "http://127.0.0.1:$MCP_PORT/sse" 2>/dev/null | head -1 || echo "")
                        if [ -n "$TOOLS" ]; then
                            echo "   Status: Connected"
                        fi
                    else
                        echo "âŒ MCP server not running (stale PID file)"
                        rm -f "$MCP_PID_FILE"
                    fi
                else
                    echo "âŒ MCP server not running"
                fi
                ;;
            
            restart)
                "$0" mcp stop
                sleep 1
                "$0" mcp start
                ;;
            
            logs)
                tail -f "${PROJECT_DIR}/logs/mcp_server.log"
                ;;
            
            *)
                echo "Usage: homeassist mcp [start|stop|status|restart|logs]"
                ;;
        esac
        ;;
    
    run)
        cd "${PROJECT_DIR}"
        source .env 2>/dev/null
        
        # Check if already running
        if pgrep -f "homeassist run" > /dev/null 2>&1; then
            EXISTING_COUNT=$(pgrep -f "homeassist run" | wc -l | xargs)
            if [ "$EXISTING_COUNT" -gt 1 ]; then
                echo "âš ï¸  HomeAssist is already running"
                echo "   Run 'homeassist stop' first to stop it"
                exit 1
            fi
        fi
        
        BLUEUTIL="/opt/homebrew/bin/blueutil"
        DEVICE_ADDRESS="98-59-49-bf-40-45"
        DEVICE_NAME="Meta Glasses"
        
        is_connected() {
            [ "$("$BLUEUTIL" --is-connected "$DEVICE_ADDRESS" 2>/dev/null)" = "1" ]
        }
        
        aggressive_connect() {
            echo ""
            echo "ğŸ”µ Searching for $DEVICE_NAME..."
            echo "   (polling every 0.5 seconds)"
            echo ""
            
            while true; do
                # Try to connect
                "$BLUEUTIL" --connect "$DEVICE_ADDRESS" 2>/dev/null &
                CONNECT_PID=$!
                
                # Wait up to 2 seconds for connection
                for i in {1..4}; do
                    if is_connected; then
                        kill $CONNECT_PID 2>/dev/null
                        wait $CONNECT_PID 2>/dev/null
                        echo ""
                        echo "âœ… $DEVICE_NAME connected!"
                        sleep 0.5
                        return 0
                    fi
                    sleep 0.5
                done
                
                kill $CONNECT_PID 2>/dev/null
                wait $CONNECT_PID 2>/dev/null
                
                # Show searching indicator
                printf "\rğŸ” Searching... "
            done
        }
        
        cleanup() {
            echo ""
            echo "ğŸ‘‹ Shutting down..."
            
            # Kill ALL audio processes FIRST (stop noise immediately)
            pkill -9 -f "say " 2>/dev/null
            pkill -9 afplay 2>/dev/null
            pkill -9 -f "ffplay" 2>/dev/null
            pkill -9 -f "mpv" 2>/dev/null
            pkill -9 -f "aplay" 2>/dev/null
            
            # Kill Python processes (assistant, termination detection, etc.)
            pkill -9 -f "assistant_framework" 2>/dev/null
            pkill -9 -f "openwakeword" 2>/dev/null
            
            # Clean up pipe if exists
            [ -n "$OUTPIPE" ] && rm -f "$OUTPIPE"
            
            exit 0
        }
        trap cleanup SIGINT SIGTERM
        
        clear
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ  HomeAssist"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Press Ctrl+C to exit"
        
        # Main loop - keeps running until user exits
        while true; do
            # Phase 1: Aggressive Bluetooth connection
            if ! is_connected; then
                aggressive_connect
            fi
            
            echo ""
            echo "ğŸš€ Starting HomeAssist..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            # Activate venv - identical to manually running in terminal
            source ./venv/bin/activate
            
            # Create a named pipe for output monitoring (PaMacCore goes to stdout)
            OUTPIPE=$(mktemp -u)
            mkfifo "$OUTPIPE"
            
            # Monitor ALL output for PaMacCore error AND verify BT on wake word ready
            (
                while IFS= read -r line; do
                    echo "$line"
                    
                    # Check for PaMacCore err=-50 (glasses disconnected during audio use)
                    if [[ "$line" == *"PaMacCore"*"-50"* ]]; then
                        echo ""
                        echo "ğŸ”´ PaMacCore error - glasses disconnected"
                        echo "ğŸ›‘ Stopping all processes..."
                        
                        # Kill ALL audio-related processes IMMEDIATELY
                        pkill -9 -f "say " 2>/dev/null
                        pkill -9 afplay 2>/dev/null
                        pkill -9 -f "ffplay" 2>/dev/null
                        pkill -9 -f "mpv" 2>/dev/null
                        pkill -9 -f "aplay" 2>/dev/null
                        
                        # Kill Python processes (assistant framework, termination detection)
                        pkill -9 -f "assistant_framework" 2>/dev/null
                        pkill -9 -f "openwakeword" 2>/dev/null
                        
                        # Also try killing by parent PID
                        pkill -9 -P $$ 2>/dev/null
                        
                        break
                    fi
                    
                    # Verify Bluetooth when wake word becomes ready (catches disconnect during boot)
                    if [[ "$line" == *"Listening for wake word"* ]] || [[ "$line" == *"Audio stream started"* ]]; then
                        # Give a tiny moment for BT state to settle
                        sleep 0.2
                        if [ "$("$BLUEUTIL" --is-connected "$DEVICE_ADDRESS" 2>/dev/null)" != "1" ]; then
                            echo ""
                            echo "ğŸ”´ Bluetooth disconnected during boot"
                            echo "ğŸ›‘ Stopping all processes..."
                            
                            # Kill ALL audio-related processes IMMEDIATELY
                            pkill -9 -f "say " 2>/dev/null
                            pkill -9 afplay 2>/dev/null
                            pkill -9 -f "ffplay" 2>/dev/null
                            pkill -9 -f "mpv" 2>/dev/null
                            pkill -9 -f "aplay" 2>/dev/null
                            
                            # Kill Python processes
                            pkill -9 -f "assistant_framework" 2>/dev/null
                            pkill -9 -f "openwakeword" 2>/dev/null
                            
                            # Also try killing by parent PID
                            pkill -9 -P $$ 2>/dev/null
                            
                            break
                        fi
                    fi
                done < "$OUTPIPE"
            ) &
            MONITOR_PID=$!
            
            # Run assistant - both stdout and stderr through pipe for monitoring
            python -u -m assistant_framework.main continuous > "$OUTPIPE" 2>&1
            EXIT_CODE=$?
            
            # Cleanup
            kill $MONITOR_PID 2>/dev/null
            wait $MONITOR_PID 2>/dev/null
            rm -f "$OUTPIPE"
            
            echo ""
            echo "ğŸ”´ Assistant exited (code: $EXIT_CODE)"
            
            # Check exit reason
            if is_connected; then
                echo ""
                echo "âš ï¸  Assistant exited unexpectedly"
                echo "ğŸ”„ Restarting in 3 seconds..."
                sleep 3
            else
                echo ""
                echo "ğŸ”´ $DEVICE_NAME disconnected"
                echo "ğŸ”„ Returning to Bluetooth search..."
                sleep 2
            fi
        done
        ;;
    
    *)
        echo "ğŸ  HomeAssist Control"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Usage: homeassist [command]"
        echo ""
        echo "Commands:"
        echo "  start      - Start all background services"
        echo "  stop       - Stop all background services"
        echo "  restart    - Restart the assistant"
        echo "  status     - Show service status"
        echo "  logs       - Show live logs"
        echo "  run        - Run assistant with Bluetooth auto-connect"
        echo "  install    - Run the service installer"
        echo "  uninstall  - Remove all services"
        echo ""
        echo "MCP Server (persistent tool server):"
        echo "  mcp start  - Start MCP server in background"
        echo "  mcp stop   - Stop MCP server"
        echo "  mcp status - Check MCP server status"
        echo "  mcp logs   - View MCP server logs"
        echo ""
        echo "Examples:"
        echo "  homeassist mcp start   # Start persistent MCP server"
        echo "  homeassist run         # Run with Bluetooth auto-connect"
        ;;
esac
